<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Mutfak Ekranƒ± - Sipari≈ü Notlarƒ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .order-card {
            border-left: 10px solid #dc3545;
            transition: transform 0.2s;
        }
        .order-card:hover {
            transform: scale(1.02);
        }
        /* YENƒ∞: Sipari≈ü notunu daha dikkat √ßekici yapan stil */
        .siparis-notu {
            background-color: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
            font-weight: bold;
            border: 1px solid #ffeeba;
            width: 100%;
        }
    </style>
</head>
<body class="bg-dark text-white">

<div class="container-fluid mt-4">
    <h2 class="text-center mb-4 text-warning">üë®‚Äçüç≥ AKTƒ∞F Sƒ∞PARƒ∞≈ûLER</h2>
    
    <div class="row" id="siparisKutusu">
        <div class="text-center mt-5 text-secondary">
            <h3>≈ûu an bekleyen sipari≈ü yok...</h3>
        </div>
    </div>
</div>

<script>
    // BASE_URL bo≈ü bƒ±rakƒ±ldƒ±, Vercel √ºzerinde otomatik √ßalƒ±≈üƒ±r
    const BASE_URL = ""; 

    window.onload = function() {
        const token = localStorage.getItem("access_token");
        if (!token) { 
            window.location.href = 'login.html'; 
            return; 
        }
        siparisleriGetir();
        setInterval(siparisleriGetir, 4000); // Mutfak i√ßin 4 saniyede bir yenileme yeterlidir
    };

    async function siparisleriGetir() {
        const token = localStorage.getItem("access_token");
        try {
            const response = await fetch(`/kitchen/orders`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            
            if (response.status === 401) {
                window.location.href = 'login.html';
                return;
            }

            const siparisler = await response.json();
            const kutu = document.getElementById("siparisKutusu");
            
            if (siparisler.length === 0) {
                kutu.innerHTML = '<div class="text-center mt-5 text-secondary"><h3>≈ûu an bekleyen sipari≈ü yok...</h3></div>';
                return;
            }

            kutu.innerHTML = ""; 

            siparisler.forEach(siparis => {
                let urunListesiHTML = "";
                siparis.items.forEach(kalem => {
                    // EƒûER NOT VARSA G√ñSTER
                    const notHTML = kalem.note ? `<div class="siparis-notu">üìå NOT: ${kalem.note}</div>` : "";
                    
                    urunListesiHTML += `
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <strong>${kalem.quantity} Adet</strong> 
                                <span>${kalem.product.name}</span>
                            </div>
                            ${notHTML}
                        </li>
                    `;
                });

                kutu.innerHTML += `
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card order-card h-100 shadow border-0">
                            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Masa: ${siparis.table_no}</h4>
                                <small>#${siparis.id}</small>
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush">${urunListesiHTML}</ul>
                            </div>
                            <div class="card-footer bg-white border-0">
                                <button onclick="hazirla(${siparis.id})" class="btn btn-success w-100 btn-lg shadow-sm">‚úÖ TAMAMLANDI</button>
                            </div>
                        </div>
                    </div>
                `;
            });

        } catch (error) { console.error("Baƒülantƒ± hatasƒ±:", error); }
    }

    async function hazirla(siparisID) {
        const token = localStorage.getItem("access_token");
        try {
            const response = await fetch(`/orders/${siparisID}/status`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token 
                },
                body: JSON.stringify({ status: "Hazƒ±r" })
            });
            
            if(response.ok) {
                siparisleriGetir(); 
            } else {
                alert("Durum g√ºncellenemedi!");
            }
        } catch(e) { console.error(e); }
    }
</script>

</body>
</html>


